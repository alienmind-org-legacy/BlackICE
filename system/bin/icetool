#!/system/xbin/bash
HELP="Usage: $0 <cmd> ..."
BASE_DIR=/sdcard/blackice
MARKET_DIR=$BASE_DIR/market
RIL_DIR=$BASE_DIR/ril
GPS_DIR=$BASE_DIR/gpsconf
WHO=`whoami`

die () {
  echo $@
  exit 1
}

if [ "$WHO" != "root" ]; then
  echo "Must be root"
  exit 1
fi

if [ "$1" = "" ]; then
  echo "$HELP"
  exit 2
fi
CMD=$1


####
# Here we setup the offered commands for the gui
# We will print the following tags:
# CATEGORIES: high level categories (=gui tabs)
# CATEGORY_COMMANDS: relation of commands included in each high level category
# COMMANDS:   all the supported commands
# OPTIONS:    options available for each command (if any)
Setup() {
  # Categories
  CATEGORIES="CATEGORIES:sys@dsp@gps@ril" # dpi is for icemarket - let's see if we merge both

  # Categories - commands relationship
  CATEGORY_COMMANDS="${CATEGORY_COMMANDS}CATEGORY_COMMANDS:sys:remount@fastcharge@charge@hosts\n"
  CATEGORY_COMMANDS="${CATEGORY_COMMANDS}CATEGORY_COMMANDS:gps:gpsconf\n"
  CATEGORY_COMMANDS="${CATEGORY_COMMANDS}CATEGORY_COMMANDS:dsp:dspinit\n"
  CATEGORY_COMMANDS="${CATEGORY_COMMANDS}CATEGORY_COMMANDS:ril:ril\n"

  # Basic commands
  SUPPORTED_COMMANDS="COMMANDS:"

  # Remount command
  SUPPORTED_COMMANDS="${SUPPORTED_COMMANDS}remount";
  COMMAND_OPTIONS="${COMMAND_OPTIONS}OPTIONS:remount:rw@ro\n";
  COMMAND_DESCRIPTIONS="${COMMAND_DESCRIPTIONS}DESCRIPTIONS:remount:Remount /system as read/write@Remount /system as read-only\n"

  # hosts command
  SUPPORTED_COMMANDS="${SUPPORTED_COMMANDS}hosts";
  COMMAND_OPTIONS="${COMMAND_OPTIONS}OPTIONS:hosts:\n";
  COMMAND_DESCRIPTIONS="${COMMAND_DESCRIPTIONS}DESCRIPTIONS:hosts:Refresh hosts file (adfree replacement)\n"

  # Density is mandatory but has 3 options
  SUPPORTED_COMMANDS="${SUPPORTED_COMMANDS}@density";
  DENSITY_LIST="190@200@240"
  DENSITY_DESCR="190 (LordClockan style)@200 (AlienMind style)@240 (Default style)"
  COMMAND_OPTIONS="${COMMAND_OPTIONS}OPTIONS:density:$DENSITY_LIST\n";
  COMMAND_DESCRIPTIONS="${COMMAND_DESCRIPTIONS}DESCRIPTIONS:density:$DENSITY_DESCR\n"

  # The rest of the commands are optional and depending on environmental factors
  if [ -f /sys/class/power_supply/battery/force_high_power_charging ]; then
    SUPPORTED_COMMANDS="$SUPPORTED_COMMANDS@fastcharge"
    COMMAND_OPTIONS="${COMMAND_OPTIONS}OPTIONS:fastcharge:1@0\n"
    COMMAND_DESCRIPTIONS="${COMMAND_DESCRIPTIONS}DESCRIPTIONS:fastcharge:Force high power charging@Disable high power charging\n"
  fi
  if [ -f /sys/devices/platform/rs30100001:00000000/power_supply/battery/charge_on_plug_enabled ]; then
    SUPPORTED_COMMANDS="$SUPPORTED_COMMANDS@charge"
    COMMAND_OPTIONS="${COMMAND_OPTIONS}OPTIONS:charge:1@0\n"
    COMMAND_DESCRIPTIONS="${COMMAND_DESCRIPTIONS}DESCRIPTIONS:charge:Enable USB charging@Disable USB charging\n"
  fi
  if [ -d $MARKET_DIR ]; then
    SUPPORTED_COMMANDS="$SUPPORTED_COMMANDS@market"
    MARKET_LIST=`for i in $MARKET_DIR/Vending*.apk; do basename $i ; done | tr '\n' '@'`
    MARKET_DESCR=$MARKET_LIST
    COMMAND_OPTIONS="${COMMAND_OPTIONS}OPTIONS:market:$MARKET_LIST\n"
    COMMAND_DESCRIPTIONS="${COMMAND_DESCRIPTIONS}DESCRIPTIONS:market:$MARKET_DESCR\n"
  fi
  if [ -d $RIL_DIR ]; then
    SUPPORTED_COMMANDS="$SUPPORTED_COMMANDS@ril"
    RIL_LIST=`ls $RIL_DIR/ | tr '\n' '@'`
    RIL_DESCR=$RIL_LIST
    COMMAND_OPTIONS="${COMMAND_OPTIONS}OPTIONS:ril:$RIL_LIST\n"
    COMMAND_DESCRIPTIONS="${COMMAND_DESCRIPTIONS}DESCRIPTIONS:ril:$RIL_DESCR\n"
  fi
  if [ -d $GPS_DIR ]; then
    SUPPORTED_COMMANDS="$SUPPORTED_COMMANDS@gpsconf"
    GPS_LIST=`ls $GPS_DIR/ | tr '\n' '@'`
    GPS_DESCR=$GPS_LIST
    COMMAND_OPTIONS="${COMMAND_OPTIONS}OPTIONS:gpsconf:$GPS_LIST\n"
    COMMAND_DESCRIPTIONS="${COMMAND_DESCRIPTIONS}DESCRIPTIONS:gpsconf:$GPS_DESCR\n"
  fi
  if [ -f /system/bin/snd3254 ]; then
    SUPPORTED_COMMANDS="$SUPPORTED_COMMANDS@dspinit"
    DSP_LIST=`echo "" | snd3254 -dspmode | grep -v Please | awk -F'.' '{ printf("%s@",$1); }'`
    DSP_DESCR=`echo "" | snd3254 -dspmode | grep -v Please | awk '{ printf("%s@",$2); }'`
    COMMAND_OPTIONS="${COMMAND_OPTIONS}OPTIONS:dspinit:$DSP_LIST\n"
    COMMAND_DESCRIPTIONS="${COMMAND_DESCRIPTIONS}DESCRIPTIONS:dspinit:$DSP_DESCR\n"
  fi
}

ListCommands() {
  printf "$SUPPORTED_COMMANDS\n"
  printf "$CATEGORIES\n"
  printf "$CATEGORY_COMMANDS"
  ( printf "$COMMAND_OPTIONS" ; printf "$COMMAND_DESCRIPTIONS" ) | sort
}

RemountSys() {
  local MODE=$1
  mount -o remount,$MODE /system
}

Reboot() {
  local PAUSE=$1
  printf "Syncing...\n"
  sync ; sync ; sync
  printf "Rebooting in $PAUSE seconds...\n"
  for i in `seq 1 $PAUSE`; do
    printf "%d." $i
    sleep 1
  done
  printf "\n"
  reboot
}

InstallMarket() {
  local APK=$1
  local VER=${APK##Vending-} 
  RemountSys "rw"
  pm uninstall com.android.vending
  rm -f /data/app/com.android.vending*apk
  cp $APK /system/app/Vending.apk
  chmod 644 /system/app/Vending.apk
  pm install $APK
  RemountSys "ro"
}

LaunchMarket() {
  am start -a android.intent.action.MAIN -n com.android.vending/com.android.vending.AssetBrowserActivity
}

Market() {
  VER=$1
  APK=$MARKET_DIR/Vending-${VER}.apk
  if [ -f $APK ]; then
    InstallMarket $APK &>/dev/null
    LaunchMarket &>/dev/null
    echo "Market $VER version installed"
  else
    echo "Couldn't find Market version $VER" 
    exit 1
  fi
}

InstallHost() {
  URL=http://someonewhocares.org/hosts/hosts
  mkdir -p /data/tmp
  cd /data/tmp
  rm -f hosts
  wget "$URL" &>/dev/null
  RET=$?
  RemountSys "rw"
  if [ "$RET" = "0" ]; then
    mv hosts /system/etc/hosts
    echo "hosts file updated"
  fi
  RemountSys "ro" 
}

FastCharge() {
  echo "$1" > /sys/class/power_supply/battery/force_high_power_charging
  echo "High power charging set to $1"
}

Charge() {
  echo "$1" > /sys/devices/platform/rs30100001:00000000/power_supply/battery/charge_on_plug_enabled
  echo "Charge on plug set to $1 - you may need to unplug/plug to make it work"
}

Remount() {
  if [ "$1" != "ro" -a "$1" != "rw" ]; then
    echo "Unknown mode $1"
    exit 1
  fi
  RemountSys "$1"
  mount | grep system
  echo "/system remounted"
}

GPSConf() {
  GPSCONF="$GPS_DIR/$1/gps.conf"
  if [ ! -f "$GPSCONF" ]; then
    echo "Nonexistent $GPSCONF!!!"
  else
    RemountSys "rw"
    cd /
    cp -p "$GPSCONF" system/etc/gps.conf
    RET=$?
    if [ "$RET" != "0" ]; then
      echo "Error copying $GPSCONF => /system/etc/gps.conf"
      exit 1
    else
      echo "GPS configuration for $1 applied - open GPS Status and redownload AGPS data"
    fi
    RemountSys "ro"
  fi
}

DSPInit() {
  MODE=$1

  # 00 <= MODE <= 99 # It is in fact to 25, but I dont want to limit this
  CHAR_STOP=$(expr "$MODE" : '\([0-9]*\)')
  test "$MODE" != "$CHAR_STOP" && die "Illegal value : $MODE"
  test $MODE -ge 00 -a $MODE -le 99 || die "Illegal value dspmode:$MODE (00>= MODE >=20)"
 
  snd3254 -dspmode $1 | grep "^DSP profile" # Remove all the options we already know
  echo "DSP profile for $1 applied"
}

RIL() {
  DIR=$RIL_DIR/$1
  if [ -d "$DIR" ]; then
    printf "RIL before patch: "
    getprop | grep RIL
    RemountSys "rw"
    cp -r $DIR/* /
    RemountSys "ro"
    echo "RIL switched to $1. Rebooting is highly recommended!"
  else 
     echo "Error: $DIR does not exist"
     exit 1
  fi
}

Density() {
  DENSITY=$1

  # 240 >= DENSITY >= 190
  CHAR_STOP=$(expr "$DENSITY" : '\([0-9]*\)')
  test "$DENSITY" != "$CHAR_STOP" && die "Illegal value : $DENSITY"
  test $DENSITY -ge 190 -a $DENSITY -le 240 || die "Illegal value Density:$DENSITY (240>= DENSITY >=190)"

  RemountSys "rw"
  sed  -i "s/ro.sf.lcd_density=.*/ro.sf.lcd_density=$DENSITY/g" /system/build.prop
  chmod 644 /system/build.prop
  RemountSys "ro"
  Reboot 5
}

###
# Cleanup - for older version directories, etc
# This wouldn't be on ICETool app, it is on users's risk
Cleanup() {
  echo "Removing old BlackICE packages from sdcard..."
  for i in /sdcard/market/  \
           /sdcard/gpsconf/ \
           /sdcard/ril/ \
           ; do
     rm -rf $i
     echo " [ $i ] Removed"
  done
}

#### Supported commands
case $CMD in
  "setup")      Setup ; ListCommands ;;
  "fastcharge") FastCharge "$2" ;;
  "charge")     Charge     "$2" ;;
  "remount")    Remount    "$2" ;;
  "hosts")      InstallHost     ;;
  "market")     Market     "$2" ;;
  "gpsconf")    GPSConf    "$2" ;;
  "dspinit")    DSPInit    "$2" ;;
  "ril")        RIL        "$2" ;;
  "density")    Density    "$2" ;;
  "cleanup")    Cleanup    "$2" ;;

  ### Any other command - we are a wrapper
  *)            exec $@ ;;
esac

exit 0
