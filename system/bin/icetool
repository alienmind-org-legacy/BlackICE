#!/system/xbin/bash
#
# icetool - by AlienMind
# ICETool.apk companion scripts
# It provides an execution interface for controlled commands,
# plus a configuration interface that allows modifying ICETool.apk
# interface (adding and removing tabs and options)
#
# TODO - merge switchlauncher separate scripts
#

ICETOOL_VERSION="0.86" # Script version
HELP="Usage: $0 <cmd> ..."
BASE_DIR=/sdcard/blackice
MARKET_DIR=$BASE_DIR/market
RIL_DIR=$BASE_DIR/ril
GPS_DIR=$BASE_DIR/gpsconf
BOOTANIM_DIR=$BASE_DIR/bootanimation/
BASE_URL=http://www.losinj.com/blackice
ICETOOL_URL=$BASE_URL/icetool.tgz
ICETOOL_VERSION_URL=$BASE_URL/icetool.version
ICETOOL_AUTORUN=$BASE_DIR/autorun.txt
RECOVERY_CMD_WHITELIST="market gpsconf ril density braviaengine bootanim switchlauncher extrapkg bootsoundoff overlay"

### More extra content to come
EXTRA_APKS="ICS_2.4_Launcher_2.apk:e518049b4359ffcd4769a98b034f73bf \
            Google+Music+4.0.1.apk:d31a972968ab0798921aa6f3b9b4aaf1 \
"

# Extra APKs
EXTRA_APKS_NAMES=`for i in $EXTRA_APKS; do B=${i%\:*} ; echo "$B@" ; done | tr '\n' ' ' | sed 's/\ *//g'`
EXTRA_APKS_DESCR="ICS v2.4 Launcher2@Google Music v4.0.1"

# Extra TGZ on /system
# FIXME - allow any tgz
EXTRA_PKGS="nexussswype.tgz:cf933c0e76022bfc16d9e00df9a0c3d0 \
            htcime.tgz:4f46cc059c890db70b324816e8722775"
EXTRA_PKG_NAMES=`for i in $EXTRA_PKGS; do B=${i%\:*} ; echo "$B@" ; done | tr '\n' ' ' | sed 's/\ *//g'`
EXTRA_PKG_DESCR="Nexus S Swype (black)@HTC IME Mod (grey)"

# Switch launcher options
EXTRA_LAUNCH_NAMES="udlauncher@adwlauncher"
EXTRA_LAUNCH_DESCR="UD Launcher (black)@ADW Launcher (color)"

### Only root allowed
WHO=`whoami`
if [ "$WHO" != "root" ]; then
  echo "Must be root"
  exit 1
fi

if [ "$1" = "" ]; then
  echo "$HELP"
  exit 2
fi

die () {
  echo $@
  exit 1
}

####
# Here we setup the offered commands for the gui
# We will print the following tags:
# CATEGORIES: high level categories (=gui tabs)
# CATEGORY_COMMANDS: relation of commands included in each high level category
# COMMANDS:   all the supported commands
# OPTIONS:    options available for each command (if any)
Setup() {
  # Categories
  CATEGORIES="CATEGORIES:sys@apps@dsp@gps@ril"

  # Categories - commands relationship
  CATEGORY_COMMANDS="${CATEGORY_COMMANDS}CATEGORY_COMMANDS:sys:upgrade@remount@fastcharge@charge@hosts@density@braviaengine\n"
  CATEGORY_COMMANDS="${CATEGORY_COMMANDS}CATEGORY_COMMANDS:apps:market@bootanim@extrapkg@switchlauncher@extraapk\n"
  CATEGORY_COMMANDS="${CATEGORY_COMMANDS}CATEGORY_COMMANDS:gps:gpsconf\n"
  CATEGORY_COMMANDS="${CATEGORY_COMMANDS}CATEGORY_COMMANDS:dsp:dspinit\n"
  CATEGORY_COMMANDS="${CATEGORY_COMMANDS}CATEGORY_COMMANDS:ril:ril\n"

  # Basic commands
  SUPPORTED_COMMANDS="COMMANDS:"

  # Upgrade command
  SUPPORTED_COMMANDS="${SUPPORTED_COMMANDS}upgrade@";
  COMMAND_OPTIONS="${COMMAND_OPTIONS}OPTIONS:upgrade:version@checkversion@icetool\n"; # TODO @rom@kernel
  COMMAND_DESCRIPTIONS="${COMMAND_DESCRIPTIONS}DESCRIPTIONS:upgrade:Show version info@Check for new version@Upgrade ICETool\n"

  # Remount command
  SUPPORTED_COMMANDS="${SUPPORTED_COMMANDS}remount@";
  COMMAND_OPTIONS="${COMMAND_OPTIONS}OPTIONS:remount:rw@ro\n";
  COMMAND_DESCRIPTIONS="${COMMAND_DESCRIPTIONS}DESCRIPTIONS:remount:Remount /system as read/write@Remount /system as read-only\n"

  # hosts command
  SUPPORTED_COMMANDS="${SUPPORTED_COMMANDS}hosts@";
  COMMAND_OPTIONS="${COMMAND_OPTIONS}OPTIONS:hosts:\n";
  COMMAND_DESCRIPTIONS="${COMMAND_DESCRIPTIONS}DESCRIPTIONS:hosts:Refresh hosts file (adfree replacement)\n"

  # Density is mandatory but has 3 options
  SUPPORTED_COMMANDS="${SUPPORTED_COMMANDS}density@";
  DENSITY_LIST="190@200@240"
  DENSITY_DESCR="Set LCD density as 190 (LordClockan style)@Set LCD density as 200 (AlienMind style)@Set LCD density as 240 (Default style)"
  COMMAND_OPTIONS="${COMMAND_OPTIONS}OPTIONS:density:$DENSITY_LIST\n";
  COMMAND_DESCRIPTIONS="${COMMAND_DESCRIPTIONS}DESCRIPTIONS:density:$DENSITY_DESCR\n"

  # BraviaEngine has 2 options
  SUPPORTED_COMMANDS="${SUPPORTED_COMMANDS}braviaengine@";
  BRAVIA_LIST="on@off"
  BRAVIA_DESCR="Enable Bravia Engine (reboot needed)@Disable Bravia Engine (reboot needed)"
  COMMAND_OPTIONS="${COMMAND_OPTIONS}OPTIONS:braviaengine:$BRAVIA_LIST\n";
  COMMAND_DESCRIPTIONS="${COMMAND_DESCRIPTIONS}DESCRIPTIONS:braviaengine:$BRAVIA_DESCR\n"

  # Boot animations catalog
  EXTRA_BOOTANIM_NAMES=`ls $BOOTANIM_DIR/ | tr '\n' '@'`
  EXTRA_BOOTANIM_DESCR=`for i in $BOOTANIM_DIR/*; do basename $i .zip ; done | tr '\n' ' ' | tr ' ' '@' | tr '-' ' '`
  SUPPORTED_COMMANDS="${SUPPORTED_COMMANDS}bootanim@";
  COMMAND_OPTIONS="${COMMAND_OPTIONS}OPTIONS:bootanim:$EXTRA_BOOTANIM_NAMES\n";
  COMMAND_DESCRIPTIONS="${COMMAND_DESCRIPTIONS}DESCRIPTIONS:bootanim:$EXTRA_BOOTANIM_DESCR\n"

  # Rest of market options
  SUPPORTED_COMMANDS="${SUPPORTED_COMMANDS}extraapk@";
  COMMAND_OPTIONS="${COMMAND_OPTIONS}OPTIONS:extraapk:$EXTRA_APKS_NAMES\n";
  COMMAND_DESCRIPTIONS="${COMMAND_DESCRIPTIONS}DESCRIPTIONS:extraapk:$EXTRA_APKS_DESCR\n"
  SUPPORTED_COMMANDS="${SUPPORTED_COMMANDS}extrapkg@";
  COMMAND_OPTIONS="${COMMAND_OPTIONS}OPTIONS:extrapkg:$EXTRA_PKG_NAMES\n";
  COMMAND_DESCRIPTIONS="${COMMAND_DESCRIPTIONS}DESCRIPTIONS:extrapkg:$EXTRA_PKG_DESCR\n"
  SUPPORTED_COMMANDS="${SUPPORTED_COMMANDS}switchlauncher@";
  COMMAND_OPTIONS="${COMMAND_OPTIONS}OPTIONS:switchlauncher:$EXTRA_LAUNCH_NAMES\n";
  COMMAND_DESCRIPTIONS="${COMMAND_DESCRIPTIONS}DESCRIPTIONS:switchlauncher:$EXTRA_LAUNCH_DESCR\n"

  # The rest of the commands are optional and depending on environmental factors
  if [ -f /sys/class/power_supply/battery/force_high_power_charging ]; then
    SUPPORTED_COMMANDS="${SUPPORTED_COMMANDS}fastcharge@"
    COMMAND_OPTIONS="${COMMAND_OPTIONS}OPTIONS:fastcharge:1@0\n"
    COMMAND_DESCRIPTIONS="${COMMAND_DESCRIPTIONS}DESCRIPTIONS:fastcharge:Force high power charging@Disable high power charging\n"
  fi
  if [ -f /sys/devices/platform/rs30100001:00000000/power_supply/battery/charge_on_plug_enabled ]; then
    SUPPORTED_COMMANDS="${SUPPORTED_COMMANDS}charge@"
    COMMAND_OPTIONS="${COMMAND_OPTIONS}OPTIONS:charge:1@0\n"
    COMMAND_DESCRIPTIONS="${COMMAND_DESCRIPTIONS}DESCRIPTIONS:charge:Enable USB charging@Disable USB charging\n"
  fi
  if [ -d $MARKET_DIR ]; then
    SUPPORTED_COMMANDS="${SUPPORTED_COMMANDS}market@"
    MARKET_LIST=`for i in $MARKET_DIR/Vending*.apk; do basename $i ; done | sed 's/Vending-//g' | sed 's/.apk//g' | tr '\n' '@'`
    MARKET_DESCR=`for i in $MARKET_DIR/Vending*.apk; do basename $i ; done | sed 's/Vending-/Install and launch Market v/g' | sed 's/.apk//g' | tr '\n' '@' `
    COMMAND_OPTIONS="${COMMAND_OPTIONS}OPTIONS:market:$MARKET_LIST\n"
    COMMAND_DESCRIPTIONS="${COMMAND_DESCRIPTIONS}DESCRIPTIONS:market:$MARKET_DESCR\n"
  fi
  if [ -d $RIL_DIR ]; then
    SUPPORTED_COMMANDS="${SUPPORTED_COMMANDS}ril@"
    RIL_LIST=`ls $RIL_DIR/ | tr '\n' '@'`
    RIL_DESCR=$RIL_LIST
    COMMAND_OPTIONS="${COMMAND_OPTIONS}OPTIONS:ril:showril@$RIL_LIST\n"
    COMMAND_DESCRIPTIONS="${COMMAND_DESCRIPTIONS}DESCRIPTIONS:ril:Show RIL info@$RIL_DESCR\n"
  fi
  if [ -d $GPS_DIR ]; then
    SUPPORTED_COMMANDS="${SUPPORTED_COMMANDS}gpsconf@"
    GPS_LIST=`ls $GPS_DIR/ | tr '\n' '@'`
    GPS_DESCR=$GPS_LIST
    COMMAND_OPTIONS="${COMMAND_OPTIONS}OPTIONS:gpsconf:$GPS_LIST\n"
    COMMAND_DESCRIPTIONS="${COMMAND_DESCRIPTIONS}DESCRIPTIONS:gpsconf:$GPS_DESCR\n"
  fi
  if [ -f /system/bin/snd3254 ]; then
    SUPPORTED_COMMANDS="${SUPPORTED_COMMANDS}dspinit@"
    DSP_LIST=`echo "" | snd3254 -dspmode | grep -v Please | awk -F'.' '{ printf("%s@",$1); }'`
    DSP_DESCR=`echo "" | snd3254 -dspmode | grep -v Please | awk '{ printf("%s@",$2); }'`
    COMMAND_OPTIONS="${COMMAND_OPTIONS}OPTIONS:dspinit:$DSP_LIST\n"
    COMMAND_DESCRIPTIONS="${COMMAND_DESCRIPTIONS}DESCRIPTIONS:dspinit:$DSP_DESCR\n"
  fi
}

ListCommands() {
  printf "ICETOOL_VERSION:$ICETOOL_VERSION\n"
  printf "$SUPPORTED_COMMANDS\n"
  printf "$CATEGORIES\n"
  printf "$CATEGORY_COMMANDS"
  ( printf "$COMMAND_OPTIONS" ; printf "$COMMAND_DESCRIPTIONS" ) | sort
}

Upgrade() {
  local MODE=$1
  case $MODE in
    "version")      PrintVersion ;;
    "checkversion") CheckVersion ;;
    "icetool")      UpgradeICETool ;;
  esac
}

PrintVersion() {
  printf "$ICETOOL_VERSION"
}

CheckVersion() {
  printf "Looking for new versions...\n"
  mkdir -p /data/tmp
  cd /data/tmp
  rm -f icetool.version
  wget "$ICETOOL_VERSION_URL" &>/dev/null
  RET=$?
  if [ "$RET" != "0" ]; then
    echo "Error checking new version"
    exit 1
  fi
  ICETOOL_REMOTE_VERSION=`cat icetool.version`
  printf "Current ICETool version: $ICETOOL_VERSION\n"
  printf "Latest version available: $ICETOOL_REMOTE_VERSION\n"
  cd - &>/dev/null
}

UpgradeICETool() {
  CheckVersion 
  RET=$?
  if [ $RET != 0 ]; then
    return $RET
  fi
  cd /data/tmp
  ICETOOL_REMOTE_VERSION=`cat icetool.version`
  if [ "$ICETOOL_VERSION" != "$ICETOOL_REMOTE_VERSION" ]; then
    rm -f icetool.tgz
    wget "$ICETOOL_URL" &>/dev/null
    RET=$?
    if [ "$RET" != "0" ]; then
      echo "Error downloading new version"
      exit 1
    fi
    cd /
    RemountSys "rw"                 &>/dev/null
    tar -xzvf /data/tmp/icetool.tgz &>/dev/null
    RemountSys "ro"                 &>/dev/null
    chmod 755 /system/bin/icetool
    chmod 644 /system/app/ICETool.apk
    cd - &>/dev/null
    echo "ICETool v$ICETOOL_REMOTE_VERSION succesfully installed. Please restart ICETool"
    exit 0
  fi
  cd - &>/dev/null
}

RemountSys() {
  local MODE=$1
  mount -o remount,$MODE /system > /dev/null 2>&1
}

Reboot() {
  local PAUSE=$1

  if [ "$RECOVERY_MODE" != "" ]; then
    return 0
  fi

  printf "Syncing...\n"
  sync ; sync ; sync
  printf "Rebooting in $PAUSE seconds...\n"
  for i in `seq 1 $PAUSE`; do
    printf "%d." $i
    sleep 1
  done
  printf "\n"
  reboot
}

InstallMarket() {
  local APK=$1
  local VER=${APK##Vending-} 
  RemountSys "rw"
  pm uninstall com.android.vending
  rm -f /data/app/com.android.vending*apk
  cp $APK /system/app/Vending.apk
  chmod 644 /system/app/Vending.apk
  if [ "$RECOVERY_MODE" != "1" ]; then
    pm install $APK
  fi
  RemountSys "ro"
}

LaunchMarket() {
  if [ "$RECOVERY_MODE" != "1" ]; then
    am start -a android.intent.action.MAIN -n com.android.vending/com.android.vending.AssetBrowserActivity
  fi
}

Market() {
  VER=$1
  APK=$MARKET_DIR/Vending-${VER}.apk
  if [ -f $APK ]; then
    InstallMarket $APK &>/dev/null
    LaunchMarket &>/dev/null
    echo "Market $VER version installed"
  else
    echo "Couldn't find Market version $VER" 
    exit 1
  fi
}

InstallHost() {
  URL=http://someonewhocares.org/hosts/hosts
  mkdir -p /data/tmp
  cd /data/tmp
  rm -f hosts
  wget "$URL" &>/dev/null
  RET=$?
  RemountSys "rw"
  if [ "$RET" = "0" ]; then
    mv hosts /system/etc/hosts
    echo "hosts file updated"
  fi
  RemountSys "ro" 
}

FastCharge() {
  echo "$1" > /sys/class/power_supply/battery/force_high_power_charging
  echo "High power charging set to $1"
}

Charge() {
  echo "$1" > /sys/devices/platform/rs30100001:00000000/power_supply/battery/charge_on_plug_enabled
  echo "Charge on plug set to $1 - you may need to unplug/plug to make it work"
}

Remount() {
  if [ "$1" != "ro" -a "$1" != "rw" ]; then
    echo "Unknown mode $1"
    exit 1
  fi
  RemountSys "$1"
  mount | grep system
  echo "/system remounted"
}

GPSConf() {
  GPSCONF="$GPS_DIR/$@/gps.conf"
  if [ ! -f "$GPSCONF" ]; then
    echo "Nonexistent $GPSCONF!!!"
  else
    RemountSys "rw"
    cd /
    cp -p "$GPSCONF" system/etc/gps.conf
    RET=$?
    if [ "$RET" != "0" ]; then
      echo "Error copying $GPSCONF => /system/etc/gps.conf"
      exit 1
    else
      echo "GPS configuration for $@ applied - open GPS Status and redownload AGPS data"
    fi
    RemountSys "ro"
  fi
}

DSPInit() {
  MODE=$1

  # 00 <= MODE <= 99 # It is in fact to 25, but I dont want to limit this
  CHAR_STOP=$(expr "$MODE" : '\([0-9]*\)')
  test "$MODE" != "$CHAR_STOP" && die "Illegal value : $MODE"
  test $MODE -ge 00 -a $MODE -le 99 || die "Illegal value dspmode:$MODE (00>= MODE >=20)"
 
  snd3254 -dspmode $1 | grep "^DSP profile" # Remove all the options we already know
  echo "DSP profile for $1 applied"
}

RIL() {
  if [ "$1" = "showril" ]; then
    getprop | grep RIL
  else
    DIR=$RIL_DIR/$1
    if [ -d "$DIR" ]; then
      printf "RIL before patch: "
      getprop | grep RIL
      RemountSys "rw"
      cp -r $DIR/* /
      RemountSys "ro"
      echo "RIL switched to $1. Rebooting is highly recommended!"
    else 
       echo "Error: $DIR does not exist"
       exit 1
    fi
  fi
}

Density() {
  DENSITY=$1

  # 240 >= DENSITY >= 190
  CHAR_STOP=$(expr "$DENSITY" : '\([0-9]*\)')
  test "$DENSITY" != "$CHAR_STOP" && die "Illegal value : $DENSITY"
  test $DENSITY -ge 190 -a $DENSITY -le 240 || die "Illegal value Density:$DENSITY (240>= DENSITY >=190)"

  RemountSys "rw"
  sed  -i "s/ro.sf.lcd_density=.*/ro.sf.lcd_density=$DENSITY/g" /system/build.prop
  chmod 644 /system/build.prop
  RemountSys "ro"
  Reboot 5
}

BraviaEngine() {
  MODE=$1

  if [ "$MODE" != "on" -a "$MODE" != "off" ]; then
    die "Illegal value : $MODE"
  fi

  RemountSys "rw"
  if [ "$MODE" = "on" ]; then
    sed  -i "s/ro.service.swiqi.supported=.*/ro.service.swiqi.supported=true/g" /system/build.prop
    sed  -i "s/persist.service.swiqi.enable=.*/persist.service.swiqi.enable=1/g" /system/build.prop
    echo "Bravia Engine enabled - reboot needed to take effect"
  elif [ "$MODE" = "off" ]; then
    sed  -i "s/ro.service.swiqi.supported=.*/ro.service.swiqi.supported=false/g" /system/build.prop
    sed  -i "s/persist.service.swiqi.enable=.*/persist.service.swiqi.enable=0/g" /system/build.prop
    echo "Bravia Engine disabled - reboot needed to take effect"
  fi
  chmod 644 /system/build.prop
  RemountSys "ro"
}


###
#
# ExtraPKG - to download extra content on /system (.tgz)
ExtraPKG() {
  if [ "$1" = "list" ]; then
    echo "$EXTRA_PKG_NAMES"
    exit 0
  fi
  PKG=$1
  for i in $EXTRA_PKGS; do
     B=${i%\:*}  # filename
     MD5SUM=${i##*:}  # md5
     if [ "$PKG" = "$B" ]; then
       URL="$BASE_URL/$B"
       break
     fi
  done

  if [ ! -d /sdcard/blackice ]; then
    MK=1
    mkdir -p /sdcard/blackice
  fi
  cd /sdcard/blackice
  if [ -f "$PKG" ]; then
    MD5=`md5sum $PKG | awk '{ print $1 }'`
    if [ "$MD5" = "$MD5SUM" ]; then
      GOOD=1
    fi
  fi
  if [ "$GOOD" != "1" ]; then
    if [ "$RECOVERY_MODE" != "1" ]; then
      rm -f "$PKG"
      wget "$URL"  &>/dev/null
      RET=$?
      if [ "$RET" != "0" ]; then
        echo "Error downloading $PKG"
        exit 1
      fi
      MD5=`md5sum $PKG | awk '{ print $1 }'`
      if [ "$MD5" = "$MD5SUM" ]; then
        GOOD=1
      fi
    else
      echo "Error checking $PKG ($MD5 != $MD5SUM) and we can't download - STOP"
    fi
  fi
  if [ "$GOOD" = "1" ]; then
    RemountSys "rw"
    cd /
    tar -xzvf /sdcard/blackice/$PKG
    chmod 644 `tar -tzvf /sdcard/blackice/$PKG | awk '(substr($NF,length($NF)) != "/"){ print $NF }'`
    RemountSys "ro"
    echo "Done!"
  else
    echo "Failed to download / install $PKG"
    exit 1
  fi
}

###
#
# Extraapp - to download APK content
ExtraAPK() {
  if [ "$1" = "list" ]; then
    echo "$EXTRA_APKS_NAMES"
    exit 0
  fi
  APK=$1
  for i in $EXTRA_APKS; do
     B=${i%\:*}  # filename
     MD5SUM=${i##*:}  # md5
     if [ "$APK" = "$B" ]; then
       URL="$BASE_URL/$B"
       break
     fi
  done

  if [ ! -d /sdcard/blackice ]; then
    MK=1
    mkdir -p /sdcard/blackice
  fi
  cd /sdcard/blackice
  # We allow having it in /data/app
  if [ ! -f "$APK" -a -f "/data/app/$APK" ]; then
    cp /data/app/$APK .
  fi
  if [ -f "$APK" ]; then
    MD5SUM=`md5sum $APK | awk '{ print $1 }'`
    if [ "$MD5" = "$MD5SUM" ]; then
      GOOD=1
    fi
  fi
  if [ "$GOOD" != "1" ]; then
    rm -f "$APK"
    wget "$URL"  &>/dev/null
    RET=$?
    if [ "$RET" != "0" ]; then
      echo "Error downloading $APK"
      exit 1
    fi
    MD5=`md5sum $APK | awk '{ print $1 }'`
    if [ "$MD5" = "$MD5SUM" ]; then
      GOOD=1
    fi
  fi
  if [ "$GOOD" = "1" ]; then
    RemountSys "rw"
    cp /sdcard/blackice/$APK /data/app/
    chmod 644 /data/app/$APK
    RemountSys "ro"
    echo "Done!"
  else
    echo "Failed to download / install $APK"
    exit 1
  fi
}

###
#
# BootAnim - copy specific bootanimation to media
BootAnim() {
  local ANIM=$BOOTANIM_DIR/$1
  RemountSys "rw"
  cp -p $ANIM /system/media/bootanimation.zip
  RemountSys "ro"
  echo "$ANIM set as new bootanimation"
}

###
#
# TestBootAnim - Play current bootanimation
TestBootAnim() {
  bootanimation &
  PID=$!
  sleep 10
  kill $PID
}

###
#
# BootSoundOff - Disable default bootsound
BootSoundOff() {
  RemountSys "rw"
  mkdir -p /data/local/boot/
  if [ -e /system/media/android_audio.mp3 ]; then
    mv /system/media/android_audio.mp3 /data/local/boot/android_audio.mp3
  fi
  RemountSys "ro"
  echo "Boot sound disabled"
}

###
#
# Overlay - Copy custom content from sdcard
Overlay() {
  local DST="$1"
  local SRC="$2"

  if [ "$DST" = "/system" ]; then
    DEV=/dev/block/mmcblk0p25
  elif [ "$DST" = "/data" ]; then
    DEV=/dev/block/mmcblk0p26
  else
    die "overlay: Invalid destination $DST"
  fi

  if [ ! -d "$SRC" ]; then
    die "overlay: Invalid source $SRC"
  fi

  mount $DEV $DST &>/dev/null || mount -o remount,rw $DEV $DST
  cp -av $SRC/* $DST/
  umount $DST
}



###
# AutoInstall
# Execute a sequence of commands available on a fixed path
# configuration file
AutoInstall() {

  # Some considerations from here:
  # * We are running in a recovery
  # * We haven't internet connection
  # * We don't want to reboot (ie: dpi command normally does)
  export RECOVERY_MODE="1"
  export PATH=$PATH:/system/bin/:/system/xbin/

  if [ -f "$ICETOOL_AUTORUN" ]; then
    echo "$ICETOOL_AUTORUN found! applying custom settings..."
    # Leave the set -x for this execution
    # This is intended to run from updater-script
    # and we want verbosity for each option applied
    cat $ICETOOL_AUTORUN | while read A; do
      COMMENT=`echo $A | grep -v ^\#`
      if [ "$COMMENT" = "" ]; then
        continue
      fi
      main $A
    done
  else
    echo "$ICETOOL_AUTORUN not found, leaving default settings..."
  fi
}

###
# Cleanup - for older version directories, etc
# This wouldn't be on ICETool app, it is on users's risk
Cleanup() {
  echo "Removing old BlackICE packages from sdcard..."
  for i in /sdcard/market/  \
           /sdcard/gpsconf/ \
           /sdcard/ril/ \
           ; do
     rm -rf $i
     echo " [ $i ] Removed"
  done
}

#### Main execution
main() {
  CMD=$1
  shift

  #### Recovery mode
  if [ "$RECOVERY_MODE" = "1" ]; then
    ALLOWED_CMD=`echo $RECOVERY_CMD_WHITELIST | grep $CMD`
    if [ "$ALLOWED_CMD" = "" ]; then
      echo "Command $CMD not allowed in recovery mode"
      exit 1
    fi
  fi

  #### All of supported commands
  case $CMD in
    "setup")        Setup ; ListCommands ;;
    "autoinstall")  AutoInstall ;;
    "upgrade")      Upgrade    "$1" ;;
    "fastcharge")   FastCharge "$1" ;;
    "charge")       Charge     "$1" ;;
    "remount")      Remount    "$1" ;;
    "hosts")        InstallHost     ;;
    "market")       Market     "$1" ;;
    "gpsconf")      GPSConf    "$@" ;;
    "dspinit")      DSPInit    "$1" ;;
    "ril")          RIL        "$1" ;;
    "density")      Density    "$1" ;;
    "braviaengine") BraviaEngine "$1" ;;
    "extraapk")     ExtraAPK   "$1" ;;
    "extrapkg")     ExtraPKG   "$1" ;;
    "bootanim")     BootAnim   "$1" ;;
    "testbootanim") TestBootAnim    ;;
    "bootsoundoff") BootSoundOff    ;;
    "overlay")      Overlay    "$1" "$2" ;;
    "cleanup")      Cleanup    "$1" ;;
  
    ### Any other command - we are a wrapper
    *)            exec $CMD $@ ;;
    esac

}

## Normal execution - just main
main $@
exit $?
